<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Tamsahya Online Education</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- ğŸ”” Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† -->
    <div id="announcementBar" class="announcement-bar" style="display:none;">
        <span id="announcementText" class="announcement-text"></span>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† -->
    <div id="adminAdBox" style="margin-top:60px; display:none;">
        <h4>ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… Ù„Ù„Ø·Ù„Ø§Ø¨</h4>
        <textarea id="adminAdText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‡Ù†Ø§..."
                  style="width:100%; min-height:80px; padding:8px;"></textarea>
        <div style="margin-top:10px;">
            <button id="saveAdBtn" class="custom-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            <button id="stopAdBtn" class="custom-btn danger">ğŸ—‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
        </div>
    </div>

    <!-- Ø¥Ø´Ø¹Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div id="updateNotification" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #1e40af;
        color: #fff;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        display: none;
        z-index: 9999;
        font-family: Arial;
    ">
        ğŸ”„ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        <button id="updateBtn" style="
            margin-right:10px;
            padding:6px 12px;
            border:none;
            border-radius:8px;
            background:#fff;
            color:#1e40af;
            cursor:pointer;
            font-weight:bold;
        ">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
    </div>

    <!-- Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ PWA -->
    <button id="installBtn" class="btn" hidden>ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

    <!-- ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
    <div id="loginPage" style="display:none;">ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div id="registerPage" style="display:none;">ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
    <div id="welcomeMessage" style="display:none;">Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ!</div>

    <!-- ØµÙØ­Ø§Øª Ø§Ù„Ø¯Ø±ÙˆØ³ -->
    <div id="gradePage" class="hidden"></div>
    <div id="subjectPage" class="hidden"></div>
    <div id="unitPage" class="hidden"></div>
    <div id="lessonPage" class="hidden">
        <div id="lessonPath" style="display:none;"></div>
        <h2 id="lessonTitle"></h2>
        <div id="lessonVideo"></div>
        <div id="lessonText"></div>
        <button id="prevLessonBtn" onclick="prevLesson()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="nextLessonBtn" onclick="nextLesson()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <div id="progressBar" style="height:6px; background:#f59e0b; width:0%; margin-top:5px;"></div>
    </div>

    <!-- ØµÙØ­Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div id="studentsList" class="hidden"></div>
    <div id="supervisorsList" class="hidden"></div>
    <div id="testsList" class="hidden"></div>
    <div id="resultsList" class="hidden"></div>
    <style>
        .hidden { display: none !important; }
        .announcement-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #f59e0b;
            color: #000;
            overflow: hidden;
            z-index: 9999;
            height: 45px;
            display: flex;
            align-items: center;
        }

        .announcement-text {
            white-space: nowrap;
            font-weight: bold;
            font-size: 16px;
            display: inline-block;
            position: relative;
            left: -100%;
        }

        @keyframes slide-right {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .custom-btn {
            padding: 6px 12px;
            margin-right: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #f59e0b;
            color: #000;
            font-weight: bold;
        }

        .custom-btn.danger {
            background-color: #e53e3e;
            color: #fff;
        }

        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(120px,1fr));
            gap:10px;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="js/firebase.js"></script>
    <script>
        // ====== Ø¹Ø±Ø¶ ØµÙØ­Ø§Øª ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ======
        function showSection(idToShow) {
            ["gradePage","subjectPage","unitPage","lessonPage",
             "studentsList","supervisorsList","testsList","resultsList"].forEach(id=>{
                const el = document.getElementById(id);
                if(el) el.classList.toggle("hidden", id !== idToShow);
            });
        }

        function resetNavigation() {
            ["gradePage","subjectPage","unitPage","lessonPage"].forEach(id=>{
                const el = document.getElementById(id);
                if(el) el.classList.add("hidden");
            });
            const path = document.getElementById("lessonPath");
            if(path) path.style.display="none";
        }

        function stopVideo() {
            const video = document.getElementById("lessonPlayer");
            if(video) { video.pause(); video.currentTime=0; video.src=""; }
        }

        function updateLessonNav(showBackUnit=true) {
            const btnBackUnit = document.getElementById("btnBackUnit");
            const btnHome = document.getElementById("btnHome");
            if(btnBackUnit) btnBackUnit.style.display=showBackUnit?"inline-block":"none";
            if(btnHome) btnHome.style.display="inline-block";
        }

        function renderLessonList() {
            const listDiv=document.getElementById("lessonList");
            if(!listDiv) return;
            listDiv.innerHTML=`<div class="lessons-grid"></div>`;
            const grid=listDiv.querySelector(".lessons-grid");
            currentLessonsList.forEach((lesson,index)=>{
                const btn=document.createElement("button");
                btn.textContent=lesson.title;
                btn.className="lesson-card";
                btn.onclick=()=>loadLesson(index);
                grid.appendChild(btn);
            });
        }

        function loadLesson(index) {
            currentLessonIndex=index;
            lessonCompleted=false;
            document.getElementById("lessonList").style.display="none";
            const lesson=currentLessonsList[index];
            document.getElementById("lessonPath").innerHTML=`
                <span>${currentSubject}</span> &gt;
                <span>${currentUnit}</span> &gt;
                <strong>${lesson.title}</strong>`;
            showLessonDetail(lesson);
            const prevBtn=document.getElementById("prevLessonBtn");
            const nextBtn=document.getElementById("nextLessonBtn");
            if(prevBtn) prevBtn.disabled=index===0;
            if(nextBtn) nextBtn.disabled=true;
            const progress=((index+1)/currentLessonsList.length)*100;
            document.getElementById("progressBar").style.width=progress+"%";
            saveLastLesson(index);
        }

        function prevLesson(){ if(currentLessonIndex>0){ currentLessonIndex--; loadLesson(currentLessonIndex); } }
        function nextLesson(){
            if(!lessonCompleted){ alert("ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ§Ù…Ù„Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ"); return; }
            if(currentLessonIndex<currentLessonsList.length-1){ currentLessonIndex++; loadLesson(currentLessonIndex); }
            else alert("ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¯Ø±ÙˆØ³ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©");
        }

        function smartBack(){
            stopVideo();
            if(currentUnit){ currentUnit=null; renderUnits(currentGrade,currentSubject);}
            else if(currentSubject){ currentSubject=null; renderSubjects(currentGrade);}
            else if(currentGrade){ currentGrade=null; renderGrades();}
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded",()=>{

            // ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const adminEmail="admin@gmail.com";
            const loggedEmail=localStorage.getItem("loggedEmail")||"";
            window.currentUser=window.currentUser||{ email:loggedEmail, role:loggedEmail===adminEmail?"ADMIN":"STUDENT"};

            // ğŸ”¹ Service Worker
            let newWorker;
            if('serviceWorker' in navigator){
                navigator.serviceWorker.register('/Al-Tamsahya-Online-Education/service-worker.js')
                    .then(reg=>{
                        console.log("Service Worker registered âœ…");
                        reg.addEventListener('updatefound',()=>{
                            newWorker=reg.installing;
                            newWorker.addEventListener('statechange',()=>{
                                if(newWorker.state==='installed' && navigator.serviceWorker.controller){
                                    newWorker.postMessage({type:'SKIP_WAITING'});
                                    const updateBox=document.getElementById("updateNotification");
                                    if(updateBox) updateBox.style.display="block";
                                }
                            });
                        });
                    }).catch(err=>console.error("SW failed âŒ",err));
            }

            // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const updateBtn=document.getElementById("updateBtn");
            if(updateBtn){ updateBtn.addEventListener("click",()=>{ if(newWorker) newWorker.postMessage({type:"SKIP_WAITING"}); }); }
            navigator.serviceWorker.addEventListener("controllerchange",()=>window.location.reload());

            // Ø¥Ø¹Ù„Ø§Ù† Ù…ØªØ­Ø±Ùƒ
            AnnouncementManager.init();

            // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            showPage('welcomeMessage');

            // Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ PWA
            const installBtn=document.getElementById("installBtn");
            let deferredPrompt;
            window.addEventListener("beforeinstallprompt", (e)=>{
                e.preventDefault(); deferredPrompt=e;
                if(installBtn) installBtn.hidden=false;
            });
            if(installBtn){ installBtn.addEventListener("click", async ()=>{
                if(!deferredPrompt){ alert("ğŸ“Œ Ø§ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ â‹® Ø«Ù… Ø§Ø®ØªØ± (Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)"); return; }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if(outcome==="accepted") installBtn.hidden=true;
                deferredPrompt=null;
            });}
            window.addEventListener("appinstalled",()=>{ if(installBtn) installBtn.hidden=true; alert("ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); });
        });
    </script>
</body>
</html>
