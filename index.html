<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Tamsahya Online Education</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .hidden { display:none; }
        .custom-btn { padding:6px 12px; margin-right:5px; cursor:pointer; border:none; border-radius:4px; background-color:#f59e0b; color:#000; font-weight:bold; }
        .custom-btn.danger { background-color:#e53e3e; color:#fff; }
        .announcement-bar { position:fixed; top:0; left:0; width:100%; background:#f59e0b; color:#000; overflow:hidden; z-index:9999; height:45px; display:flex; align-items:center; }
        .announcement-text { white-space:nowrap; font-weight:bold; font-size:16px; display:inline-block; position:relative; left:-100%; }
        @keyframes slide-right { 0%{left:-100%;} 100%{left:100%;} }
    </style>
</head>
<body>

    <!-- ØµÙØ­Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="loginPage" class="hidden"></div>
    <div id="registerPage" class="hidden"></div>
    <div id="welcomeMessage" class="hidden"></div>

    <!-- ØµÙØ­Ø§Øª Ø§Ù„Ø¯Ø±ÙˆØ³ -->
    <div id="gradePage" class="hidden"></div>
    <div id="subjectPage" class="hidden"></div>
    <div id="unitPage" class="hidden"></div>
    <div id="lessonPage" class="hidden"></div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <div id="admin-panel" class="hidden"></div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† -->
    <div id="announcementBar" class="announcement-bar" style="display:none;">
        <span id="announcementText" class="announcement-text"></span>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† -->
    <div id="adminAdBox" style="margin-top:60px; display:none;">
        <h4>ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… Ù„Ù„Ø·Ù„Ø§Ø¨</h4>
        <textarea id="adminAdText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‡Ù†Ø§..." style="width:100%; min-height:80px; padding:8px;"></textarea>
        <div style="margin-top:10px;">
            <button id="saveAdBtn" class="custom-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            <button id="stopAdBtn" class="custom-btn danger">ğŸ—‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
        </div>
    </div>

    <!-- Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <button id="installBtn" class="btn" hidden>ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

    <!-- Ø¥Ø´Ø¹Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div id="updateNotification" style="
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e40af;
      color: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      display: none;
      z-index: 9999;
      font-family: Arial;">
        ğŸ”„ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        <button id="updateBtn" style="
            margin-right:10px;
            padding:6px 12px;
            border:none;
            border-radius:8px;
            background:#fff;
            color:#1e40af;
            cursor:pointer;
            font-weight:bold;">
            ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†
        </button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="js/firebase.js"></script>

    <!-- ==============================
         Ø¨Ø¯Ø§ÙŠØ© Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„Ø¯Ø±ÙˆØ³
         ============================== -->
    <script>
        // ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        const adminEmail = "admin@gmail.com";
        const loggedEmail = localStorage.getItem("loggedEmail") || "";

        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
        window.currentUser = window.currentUser || {
            email: loggedEmail,
            role: loggedEmail === adminEmail ? "ADMIN" : "STUDENT"
        };

        // Ù…ØªØºÙŠØ± Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ PWA
        let deferredPrompt = null;

        // ğŸ”¹ Ø¥Ø¹Ù„Ø§Ù† Ù…ØªØºÙŠØ± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø±ÙƒØ§Øª
        let animationTimeout = null;

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¯Ø±ÙˆØ³
        let currentGrade=null, currentSubject=null, currentUnit=null;
        let currentLessonsList=[], currentLessonIndex=0, lessonCompleted=false;

        // ==============================
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±ÙˆØ³
        function renderLessons(grade, subject, unit) {
            resetNavigation();

            currentLessonsList = lessons[grade][subject][unit];

            const lastIndex = getLastLesson();
            currentLessonIndex = lastIndex!==null && lastIndex<currentLessonsList.length ? lastIndex : 0;
            document.getElementById("lessonPath").style.display="block";

            showSection("lessonPage");
            updateBackButton();

            document.getElementById("lessonTitle").textContent=`${grade} - ${subject} - ${unit}`;

            renderLessonList();
            loadLesson(currentLessonIndex);
        }

        function showLessonDetail(lesson) {
            const videoDiv=document.getElementById("lessonVideo");
            const textDiv=document.getElementById("lessonText");

            videoDiv.innerHTML=`
                <video id="lessonPlayer" controls playsinline preload="auto" muted width="100%" style="max-height:220px; border-radius:12px;">
                    <source src="./videos/Lesson1.mp4.mp4?v=1" type="video/mp4">
                    Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                </video>
            `;

            const video=document.getElementById("lessonPlayer");
            if(video){
                video.play().catch(err=>console.log("Autoplay blocked:",err));

                lessonCompleted=false;
                const nextBtn=document.getElementById("nextLessonBtn");
                if(nextBtn) nextBtn.disabled=true;

                video.addEventListener("loadeddata",()=>{
                    video.muted=false;
                    video.play().catch(()=>console.log("Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„ØµÙˆØª"));
                });

                video.addEventListener("ended",()=>{
                    lessonCompleted=true;
                    if(nextBtn) nextBtn.disabled=false;
                    saveLastLesson(currentLessonIndex);
                });
            }

            textDiv.textContent=lesson.content;
            updateLessonNav(true);
        }

        // ==============================
        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³
        function renderLessonList() {
            const listDiv=document.getElementById("lessonList");
            if(!listDiv) return;

            listDiv.innerHTML=`<div class="lessons-grid"></div>`;
            const grid=listDiv.querySelector(".lessons-grid");

            currentLessonsList.forEach((lesson,index)=>{
                const btn=document.createElement("button");
                btn.textContent=lesson.title;
                btn.className="lesson-card";
                btn.onclick=()=>loadLesson(index);
                grid.appendChild(btn);
            });
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¯Ø±Ø³ Ù…Ø¹ÙŠÙ†
        function loadLesson(index){
            currentLessonIndex=index;
            lessonCompleted=false;
            document.getElementById("lessonList").style.display="none";

            const lesson=currentLessonsList[index];

            document.getElementById("lessonPath").innerHTML=`
                <span>${currentSubject}</span>
                <span> &gt; </span>
                <span>${currentUnit}</span>
                <span> &gt; </span>
                <strong>${lesson.title}</strong>
            `;

            showLessonDetail(lesson);

            const prevBtn=document.getElementById("prevLessonBtn");
            const nextBtn=document.getElementById("nextLessonBtn");

            if(prevBtn) prevBtn.disabled=index===0;
            if(nextBtn) nextBtn.disabled=true;

            const progress=((index+1)/currentLessonsList.length)*100;
            document.getElementById("progressBar").style.width=progress+"%";

            saveLastLesson(index);
        }

        // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø±ÙˆØ³
        function prevLesson(){
            if(currentLessonIndex>0){
                currentLessonIndex--;
                loadLesson(currentLessonIndex);
            }
        }

        function nextLesson(){
            if(!lessonCompleted){
                alert("ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ§Ù…Ù„Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ");
                return;
            }
            if(currentLessonIndex<currentLessonsList.length-1){
                currentLessonIndex++;
                loadLesson(currentLessonIndex);
            } else {
                alert("ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¯Ø±ÙˆØ³ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©");
            }
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        function back(page){
            stopVideo();
            updateLessonNav(false);
            document.getElementById("lessonList").style.display="block";

            switch(page){
                case "grade": renderGrades(); break;
                case "subject": if(currentGrade) renderSubjects(currentGrade); break;
                case "unit": if(currentGrade && currentSubject) renderUnits(currentGrade,currentSubject); break;
                default: renderGrades();
            }
        }

        function smartBack(){
            stopVideo();
            if(currentUnit){ currentUnit=null; renderUnits(currentGrade,currentSubject); }
            else if(currentSubject){ currentSubject=null; renderSubjects(currentGrade); }
            else if(currentGrade){ currentGrade=null; renderGrades(); }
        }

        // Ø¹Ø±Ø¶ Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ù‚ÙŠØ©
        function showSection(idToShow){
            ["gradePage","subjectPage","unitPage","lessonPage"].forEach(id=>{
                document.getElementById(id).classList.toggle("hidden",id!==idToShow);
            });
        }

        function hideAllAdminSections(){
            ["studentsList","supervisorsList","testsList","resultsList"].forEach(id=>{
                document.getElementById(id).classList.add("hidden");
            });
        }

        function showAdminSection(section){
            hideAllAdminSections();
            switch(section){
                case "students": renderStudents(); break;
                case "supervisors": renderSupervisors(); break;
                case "tests": renderTests(); break;
                case "results": renderResults(); break;
            }
        }

        async function loadPendingStudents(){
            const res=await fetch("/api/students/pending");
            const data=await res.json();
            console.log(data);
        }

        // ==============================
        // ğŸ‘¨â€ğŸ’¼ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø´Ø±ÙÙŠÙ†
        async function renderStudents(){
            const container=document.getElementById("studentsList");
            container.classList.remove("hidden");
            ["supervisorsList","testsList","resultsList"].forEach(id=>document.getElementById(id)?.classList.add("hidden"));

            try{
                const db=window.firestoreTools.db;
                const snapshot=await db.collection("students").get();
                savedStudents=[];

                let totalStudents=snapshot.size;
                let approvedStudents=0;
                let pendingStudents=0;
                let rows="";

                snapshot.forEach(doc=>{
                    const student=doc.data();
                    savedStudents.push({
                        id:doc.id,
                        email:student.email||"",
                        approved:student.approved===true,
                        grade:student.grade||"-"
                    });

                    if(student.approved) approvedStudents++;
                    else pendingStudents++;

                    rows+=`
<tr data-email="${(student.email||"").toLowerCase()}">
  <td>${student.email||"-"}</td>
  <td>${student.approved?"ğŸŸ¢ Ù…ÙØ¹Ù„":"ğŸŸ¡ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"}</td>
  <td>${student.grade||"-"}</td>
  <td class="actions-cell">
    <div class="actions-wrapper">
      ${currentUser?.role==="ADMIN"?`
        <button class="custom-btn" onclick="editStudent('${student.email}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="custom-btn danger" onclick="deleteUser('${doc.id}','students')">ğŸ—‘ Ø­Ø°Ù</button>
        ${!student.approved?`
          <button class="custom-btn" onclick="setApprove('${doc.id}',true)">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
          <button class="custom-btn danger" onclick="rejectStudent('${doc.id}')">âŒ Ø±ÙØ¶</button>
        `:""}
      `:""}
      ${currentUser?.role==="SUPERVISOR" && !student.approved?`
        <button class="custom-btn" onclick="setApprove('${doc.id}',true)">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
      `:""}
    </div>
  </td>
</tr>`;
                });

                container.innerHTML=`
<h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h4>
<input id="studentSearch" onkeyup="filterStudents()" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯">
<div style="margin:10px 0;">ğŸ“š Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <strong>${totalStudents}</strong></div>
<div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
  <div class="stat-box approved">ğŸŸ¢ Ù…ÙØ¹Ù„ÙŠÙ†: ${approvedStudents}</div>
  <div class="stat-box pending">ğŸŸ¡ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: ${pendingStudents}</div>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
<th>Ø®ÙŠØ§Ø±Ø§Øª</th>
</tr>
</thead>
<tbody>
${rows||`<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</td></tr>`}
</tbody>
</table>
</div>
`;
            } catch(err){
                console.error(err);
                container.innerHTML=`<p>Ø­Ø¯Ø« Ø®Ø·Ø£ âŒ<br>${err.message}</p>`;
            }
        }

        async function editStudent(studentEmail){
            try{
                const db=window.firestoreTools.db;
                const snap=await db.collection("students").where("email","==",(studentEmail||"").toLowerCase()).get();
                if(snap.empty){ alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ âŒ"); return; }

                const docSnap=snap.docs[0];
                const student=docSnap.data();
                const docId=docSnap.id;

                const newEmail=prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:",student.email||"");
                if(!newEmail) return;
                const newPassword=prompt("ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:",student.password||"");
                if(!newPassword) return;

                await db.collection("students").doc(docId).update({
                    email:newEmail.trim().toLowerCase(),
                    password:newPassword.trim(),
                    name:newEmail.trim().toLowerCase().split("@")[0]
                });

                alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ âœ…");
                renderStudents();
            } catch(err){
                console.error(err);
                alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âŒ\n"+err.message);
            }
        }

        function showAddStudentModal(){
            document.getElementById("newStudentEmail").value="";
            document.getElementById("newStudentPassword").value="";
            document.getElementById("studentModal").style.display="flex";
        }

        async function addStudent(){
            const email=document.getElementById("newStudentEmail").value.trim().toLowerCase();
            const password=document.getElementById("newStudentPassword").value.trim();
            if(!email||!password){ alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!"); return; }

            try{
                const db=window.firestoreTools.db;
                const snap=await db.collection("students").where("email","==",email).get();
                if(!snap.empty){ alert("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„!"); return; }

                await db.collection("students").add({
                    name: email.split("@")[0],
                    email,
                    password,
                    role: "STUDENT",
                    approved: true,
                    createdAt: new Date().toISOString()
                });

                alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                closeModal("studentModal");
                renderStudents();
            } catch(err){
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ âŒ");
            }
        }

        // ==============================
        // ğŸ‘¨â€ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
        // ==============================
        async function renderSupervisors(){
            const container=document.getElementById("supervisorsList");
            container.classList.remove("hidden");
            ["studentsList","testsList","resultsList"].forEach(id=>document.getElementById(id).classList.add("hidden"));

            container.innerHTML=`
<h4>Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ†</h4>
<button class="custom-btn" onclick="showAddSupervisorModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù</button>
<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†...</p>
`;

            try{
                if(!window.firestoreTools||!window.firestoreTools.db){
                    container.innerHTML=`<p>Firebase Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ âŒ</p>`;
                    return;
                }

                const db=window.firestoreTools.db;
                const snap=await db.collection("users").where("role","==","SUPERVISOR").get();
                let rows="";
                snap.forEach(docSnap=>{
                    const s=docSnap.data();
                    const id=docSnap.id;
                    rows+=`
<tr>
<td>${s.email||"-"}</td>
<td>
<button class="custom-btn" onclick="deleteUser('${id}','users')">Ø­Ø°Ù</button>
</td>
</tr>`;
                });

                container.innerHTML=`
<h4>Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ†</h4>
<button class="custom-btn" onclick="showAddSupervisorModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù</button>
<div style="margin:10px 0;">
  <button onclick="filterStudents('all')">Ø§Ù„ÙƒÙ„</button>
  <button onclick="filterStudents('approved')">ğŸŸ¢ Ù…ÙØ¹Ù„ÙŠÙ†</button>
  <button onclick="filterStudents('pending')">ğŸŸ¡ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
<th>Ø®ÙŠØ§Ø±Ø§Øª</th>
</tr>
</thead>
<tbody>
${rows||`<tr><td colspan="2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§</td></tr>`}
</tbody>
</table>
</div>
`;
            } catch(err){
                console.error(err);
                container.innerHTML=`<p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† âŒ<br>${err.message}</p>`;
            }
        }

        function showAddSupervisorModal(){
            document.getElementById("newSupervisorEmail").value="";
            document.getElementById("newSupervisorPassword").value="";
            document.getElementById("supervisorModal").style.display="flex";
        }

        async function addSupervisor(){
            const email=document.getElementById("newSupervisorEmail").value.trim().toLowerCase();
            const password=document.getElementById("newSupervisorPassword").value.trim();
            if(!email||!password){ alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!"); return; }

            try{
                if(!window.firestoreTools||!window.firestoreTools.db){ alert("Firebase Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ âŒ"); return; }
                const db=window.firestoreTools.db;
                const snap=await db.collection("users").where("email","==",email).get();
                if(!snap.empty){ alert("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„!"); return; }

                await db.collection("users").add({
                    name: email.split("@")[0],
                    email,
                    password,
                    role: "SUPERVISOR",
                    createdAt: new Date().toISOString()
                });

                alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                closeModal("supervisorModal");
                renderSupervisors();
            } catch(err){
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù âŒ\n"+err.message);
            }
        }

        // ==============================
        // ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…/Ø·Ø§Ù„Ø¨ (Firestore)
        async function deleteUser(docId,collectionName){
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
            try{
                const db=window.firestoreTools.db;
                await db.collection(collectionName).doc(docId).delete();
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                if(collectionName==="students") renderStudents();
                if(collectionName==="users") renderSupervisors();
            } catch(err){
                console.error(err);
                alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù âŒ\n"+err.message);
            }
        }

        // âœ… Ù…ÙˆØ§ÙÙ‚Ø© / Ø±ÙØ¶ Ø·Ø§Ù„Ø¨
        async function setApprove(studentDocId,approvedValue){
            try{
                const db=window.firestoreTools.db;
                const ref=db.collection("students").doc(studentDocId);
                const snap=await ref.get();
                if(!snap.exists) return;

                if(snap.data().approved===true){
                    alert("Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙØ¹Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ âœ…");
                    return;
                }

                await ref.update({approved:approvedValue});
                alert("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© âœ…");
                renderStudents();
            } catch(err){
                console.error(err);
                alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« âŒ");
            }
        }

        // âŒ Ø±ÙØ¶ Ø§Ù„Ø·Ø§Ù„Ø¨
        async function rejectStudent(studentDocId){
            if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ­Ø°Ù Ø·Ù„Ø¨Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            try{
                const db=window.firestoreTools.db;
                await db.collection("students").doc(studentDocId).delete();
                alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ­Ø°ÙÙ‡ âŒ");
                renderStudents();
            } catch(err){
                console.error(err);
                alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¶ âŒ\n"+err.message);
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        function closeModal(id){
            document.getElementById(id).style.display="none";
        }

        function renderTests(){
            const container=document.getElementById("testsList");
            container.innerHTML=`<h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h4><p>Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>`;
            container.classList.remove("hidden");
            ["studentsList","supervisorsList","resultsList"].forEach(id=>document.getElementById(id).classList.add("hidden"));
        }

        function renderResults(){
            const container=document.getElementById("resultsList");
            container.innerHTML=`<h4>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h4><p>Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨.</p>`;
            container.classList.remove("hidden");
            ["studentsList","supervisorsList","testsList"].forEach(id=>document.getElementById(id).classList.add("hidden"));
        }

        function resetNavigation(){
            document.getElementById("gradePage").classList.add("hidden");
            document.getElementById("subjectPage").classList.add("hidden");
            document.getElementById("unitPage").classList.add("hidden");
            document.getElementById("lessonPage").classList.add("hidden");
            document.getElementById("lessonPath").style.display="none";
        }

        function stopVideo(){
            const video=document.getElementById("lessonPlayer");
            if(video){ video.pause(); video.currentTime=0; video.src=""; }
        }

        function updateLessonNav(showBackUnit=true){
            const btnBackUnit=document.getElementById("btnBackUnit");
            const btnHome=document.getElementById("btnHome");
            if(btnBackUnit) btnBackUnit.style.display=showBackUnit?"inline-block":"none";
            if(btnHome) btnHome.style.display="inline-block";
        }

        function updateGlobalNav(show){
            const nav=document.getElementById("globalNav");
            if(!nav) return;
            if(show) nav.classList.remove("hidden");
            else nav.classList.add("hidden");
        }

        function toggleLessons(){
            const list=document.getElementById("lessonList");
            list.style.display=list.style.display==="none"?"block":"none";
        }

        function toggleDarkMode(){
            document.body.classList.toggle("dark-mode");
        }

        localStorage.setItem("darkMode",document.body.classList.contains("dark-mode"));
        if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark-mode");

        // ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« PWA
        const updateBtn=document.getElementById("updateBtn");
        if(updateBtn) updateBtn.addEventListener("click",()=>{
            if(newWorker) newWorker.postMessage({type:"SKIP_WAITING"});
        });

        navigator.serviceWorker.addEventListener("controllerchange",()=>{ window.location.reload(); });

        const adminEmail="admin@gmail.com";
        const loggedEmail=localStorage.getItem("loggedEmail")||"";
        window.currentUser=window.currentUser||{email:loggedEmail,role:loggedEmail===adminEmail?"ADMIN":"STUDENT"};

        let deferredPrompt=null;
        animationTimeout=null;

        document.addEventListener("DOMContentLoaded",()=>{
            if(window.currentUser.role==="ADMIN"){
                const adminPanel=document.getElementById("admin-panel");
                if(adminPanel) adminPanel.style.display="block";

                const titleInput=document.getElementById("ad-title");
                const contentInput=document.getElementById("ad-content");
                const addBtn=document.getElementById("add-ad-btn");

                if(addBtn&&titleInput&&contentInput){
                    addBtn.addEventListener("click",async ()=>{
                        const title=titleInput.value.trim();
                        const content=contentInput.value.trim();
                        if(!title||!content) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰!");

                        try{
                            await firestoreTools.addDoc(firestoreTools.collection("ads"),{title,content,date:new Date()});
                            titleInput.value="";
                            contentInput.value="";
                            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­!");
                        } catch(err){
                            console.error(err);
                            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âŒ\n"+err.message);
                        }
                    });
                }
            }
        });

        document.addEventListener("DOMContentLoaded",()=>{
            const adsContainer=document.getElementById("ads-container");
            if(adsContainer&&window.firestoreTools&&firestoreTools.collection){
                firestoreTools.collection("ads").orderBy("date","desc").onSnapshot(snapshot=>{
                    adsContainer.innerHTML="";
                    snapshot.forEach(doc=>{
                        const ad=doc.data();
                        const adElement=document.createElement("div");
                        adElement.className="ad";
                        adElement.innerHTML=`
<h3>${ad.title}</h3>
<p>${ad.content}</p>
<small>${ad.date.toDate().toLocaleString()}</small>`;
                        adsContainer.appendChild(adElement);
                    });
                });
            }

            const installBtn=document.getElementById("installBtn");
            window.addEventListener("beforeinstallprompt",e=>{
                e.preventDefault();
                deferredPrompt=e;
                if(installBtn) installBtn.hidden=false;
            });

            if(installBtn){
                installBtn.addEventListener("click",async ()=>{
                    if(!deferredPrompt){ alert("ğŸ“Œ Ø§ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ â‹® Ø«Ù… Ø§Ø®ØªØ± (Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)"); return; }
                    deferredPrompt.prompt();
                    const {outcome}=await deferredPrompt.userChoice;
                    if(outcome==="accepted") installBtn.hidden=true;
                    deferredPrompt=null;
                });
            }

            window.addEventListener("appinstalled",()=>{
                if(installBtn) installBtn.hidden=true;
                alert("ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            });
        });

        let animationTimeout=null;
        function startAnnouncementAnimation(text,duration=12000){
            const bar=document.getElementById("announcementBar");
            const textBox=document.getElementById("announcementText");
            if(!bar||!textBox||!text?.trim()){ hideAnnouncementBar(); return; }

            textBox.innerText="ğŸ“¢ "+text+" ğŸ“¢";
            bar.style.display="flex";

            const screenWidth=bar.offsetWidth;
            const textWidth=textBox.offsetWidth;

            function move(){
                textBox.style.transition="none";
                textBox.style.left=-textWidth+"px";
                setTimeout(()=>{
                    textBox.style.transition=`left ${duration}ms linear`;
                    textBox.style.left=screenWidth+"px";
                },50);
                animationTimeout=setTimeout(move,duration+2000);
            }

            move();
        }

        function hideAnnouncementBar(){
            const bar=document.getElementById("announcementBar");
            if(bar) bar.style.display="none";
            if(animationTimeout){ clearTimeout(animationTimeout); animationTimeout=null; }
        }

        const AnnouncementManager={
            lastText:"",
            init(){
                this.announcementText=document.getElementById("announcementText");
                this.saveBtn=document.getElementById("saveAdBtn");
                this.stopBtn=document.getElementById("stopAdBtn");
                this.adminTextarea=document.getElementById("adminAdText");

                const isAdmin=true;
                if(isAdmin) document.getElementById("adminAdBox").style.display="block";

                this.bindEvents();
            },
            bindEvents(){
                if(this.saveBtn) this.saveBtn.addEventListener("click",()=>this.saveAnnouncement());
                if(this.stopBtn) this.stopBtn.addEventListener("click",()=>this.deleteAnnouncement());

                if(this.adminTextarea){
                    let timeout=null;
                    this.adminTextarea.addEventListener("input",()=>{
                        clearTimeout(timeout);
                        timeout=setTimeout(()=>this.saveLiveAnnouncement(),500);
                    });
                }
            },
            showBar(){ const bar=document.getElementById("announcementBar"); if(bar) bar.style.display="flex"; },
            hideBar(){ const bar=document.getElementById("announcementBar"); if(bar) bar.style.display="none"; },
            restartAnimation(){
                if(!this.announcementText) return;
                this.announcementText.style.animation="none";
                this.announcementText.style.left="-100%";
                this.announcementText.offsetHeight;
                const textLength=this.announcementText.offsetWidth;
                const duration=Math.max(15,textLength/50);
                this.announcementText.style.animation=`slide-right ${duration}s linear infinite`;
            },
            updateAnnouncementText(text){
                if(!this.announcementText) return;
                if(text?.trim()&&text!==this.lastText){
                    this.announcementText.innerText="ğŸ“¢ "+text+" ğŸ“¢";
                    this.restartAnimation();
                    this.showBar();
                    this.lastText=text;
                } else if(!text?.trim()){ this.announcementText.innerText=""; this.hideBar(); this.lastText=""; }
            },
            async saveAnnouncement(){
                const text=this.adminTextarea?.value.trim()||"";
                if(!text) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø£ÙˆÙ„Ø§Ù‹!");
                try{ await firestoreTools.db.collection("announcements").doc("current").set({text}); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âœ…"); }
                catch(err){ console.error(err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ âŒ\n"+err.message); }
                this.updateAnnouncementText(text);
            },
            deleteAnnouncement(){ this.adminTextarea.value=""; this.updateAnnouncementText(""); try{ firestoreTools.db.collection("announcements").doc("current").delete(); } catch(err){ console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:",err.message); } },
            saveLiveAnnouncement(){ const text=this.adminTextarea.value; this.updateAnnouncementText(text); }
        };

        document.addEventListener("DOMContentLoaded",()=>AnnouncementManager.init());

        const pages=['loginPage','registerPage','welcomeMessage'];
        function showPage(pageId){ pages.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; }); const page=document.getElementById(pageId); if(page) page.style.display='block'; }
        window.onload=()=>{ showPage('welcomeMessage'); };
        // ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« PWA
        const updateBtn=document.getElementById("updateBtn");
        if(updateBtn) updateBtn.addEventListener("click",()=>{
            if(newWorker) newWorker.postMessage({type:"SKIP_WAITING"});
        });

        navigator.serviceWorker.addEventListener("controllerchange",()=>{ window.location.reload(); });

        const adminEmail="admin@gmail.com";
        const loggedEmail=localStorage.getItem("loggedEmail")||"";
        window.currentUser=window.currentUser||{email:loggedEmail,role:loggedEmail===adminEmail?"ADMIN":"STUDENT"};

        let deferredPrompt=null;
        animationTimeout=null;

        document.addEventListener("DOMContentLoaded",()=>{
            if(window.currentUser.role==="ADMIN"){
                const adminPanel=document.getElementById("admin-panel");
                if(adminPanel) adminPanel.style.display="block";

                const titleInput=document.getElementById("ad-title");
                const contentInput=document.getElementById("ad-content");
                const addBtn=document.getElementById("add-ad-btn");

                if(addBtn&&titleInput&&contentInput){
                    addBtn.addEventListener("click",async ()=>{
                        const title=titleInput.value.trim();
                        const content=contentInput.value.trim();
                        if(!title||!content) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰!");

                        try{
                            await firestoreTools.addDoc(firestoreTools.collection("ads"),{title,content,date:new Date()});
                            titleInput.value="";
                            contentInput.value="";
                            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­!");
                        } catch(err){
                            console.error(err);
                            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âŒ\n"+err.message);
                        }
                    });
                }
            }
        });

        document.addEventListener("DOMContentLoaded",()=>{
            const adsContainer=document.getElementById("ads-container");
            if(adsContainer&&window.firestoreTools&&firestoreTools.collection){
                firestoreTools.collection("ads").orderBy("date","desc").onSnapshot(snapshot=>{
                    adsContainer.innerHTML="";
                    snapshot.forEach(doc=>{
                        const ad=doc.data();
                        const adElement=document.createElement("div");
                        adElement.className="ad";
                        adElement.innerHTML=`
<h3>${ad.title}</h3>
<p>${ad.content}</p>
<small>${ad.date.toDate().toLocaleString()}</small>`;
                        adsContainer.appendChild(adElement);
                    });
                });
            }

            const installBtn=document.getElementById("installBtn");
            window.addEventListener("beforeinstallprompt",e=>{
                e.preventDefault();
                deferredPrompt=e;
                if(installBtn) installBtn.hidden=false;
            });

            if(installBtn){
                installBtn.addEventListener("click",async ()=>{
                    if(!deferredPrompt){ alert("ğŸ“Œ Ø§ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ â‹® Ø«Ù… Ø§Ø®ØªØ± (Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)"); return; }
                    deferredPrompt.prompt();
                    const {outcome}=await deferredPrompt.userChoice;
                    if(outcome==="accepted") installBtn.hidden=true;
                    deferredPrompt=null;
                });
            }

            window.addEventListener("appinstalled",()=>{
                if(installBtn) installBtn.hidden=true;
                alert("ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            });
        });

        let animationTimeout=null;
        function startAnnouncementAnimation(text,duration=12000){
            const bar=document.getElementById("announcementBar");
            const textBox=document.getElementById("announcementText");
            if(!bar||!textBox||!text?.trim()){ hideAnnouncementBar(); return; }

            textBox.innerText="ğŸ“¢ "+text+" ğŸ“¢";
            bar.style.display="flex";

            const screenWidth=bar.offsetWidth;
            const textWidth=textBox.offsetWidth;

            function move(){
                textBox.style.transition="none";
                textBox.style.left=-textWidth+"px";
                setTimeout(()=>{
                    textBox.style.transition=`left ${duration}ms linear`;
                    textBox.style.left=screenWidth+"px";
                },50);
                animationTimeout=setTimeout(move,duration+2000);
            }

            move();
        }

        function hideAnnouncementBar(){
            const bar=document.getElementById("announcementBar");
            if(bar) bar.style.display="none";
            if(animationTimeout){ clearTimeout(animationTimeout); animationTimeout=null; }
        }

        const AnnouncementManager={
            lastText:"",
            init(){
                this.announcementText=document.getElementById("announcementText");
                this.saveBtn=document.getElementById("saveAdBtn");
                this.stopBtn=document.getElementById("stopAdBtn");
                this.adminTextarea=document.getElementById("adminAdText");

                const isAdmin=true;
                if(isAdmin) document.getElementById("adminAdBox").style.display="block";

                this.bindEvents();
            },
            bindEvents(){
                if(this.saveBtn) this.saveBtn.addEventListener("click",()=>this.saveAnnouncement());
                if(this.stopBtn) this.stopBtn.addEventListener("click",()=>this.deleteAnnouncement());

                if(this.adminTextarea){
                    let timeout=null;
                    this.adminTextarea.addEventListener("input",()=>{
                        clearTimeout(timeout);
                        timeout=setTimeout(()=>this.saveLiveAnnouncement(),500);
                    });
                }
            },
            showBar(){ const bar=document.getElementById("announcementBar"); if(bar) bar.style.display="flex"; },
            hideBar(){ const bar=document.getElementById("announcementBar"); if(bar) bar.style.display="none"; },
            restartAnimation(){
                if(!this.announcementText) return;
                this.announcementText.style.animation="none";
                this.announcementText.style.left="-100%";
                this.announcementText.offsetHeight;
                const textLength=this.announcementText.offsetWidth;
                const duration=Math.max(15,textLength/50);
                this.announcementText.style.animation=`slide-right ${duration}s linear infinite`;
            },
            updateAnnouncementText(text){
                if(!this.announcementText) return;
                if(text?.trim()&&text!==this.lastText){
                    this.announcementText.innerText="ğŸ“¢ "+text+" ğŸ“¢";
                    this.restartAnimation();
                    this.showBar();
                    this.lastText=text;
                } else if(!text?.trim()){ this.announcementText.innerText=""; this.hideBar(); this.lastText=""; }
            },
            async saveAnnouncement(){
                const text=this.adminTextarea?.value.trim()||"";
                if(!text) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø£ÙˆÙ„Ø§Ù‹!");
                try{ await firestoreTools.db.collection("announcements").doc("current").set({text}); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âœ…"); }
                catch(err){ console.error(err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ âŒ\n"+err.message); }
                this.updateAnnouncementText(text);
            },
            deleteAnnouncement(){ this.adminTextarea.value=""; this.updateAnnouncementText(""); try{ firestoreTools.db.collection("announcements").doc("current").delete(); } catch(err){ console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:",err.message); } },
            saveLiveAnnouncement(){ const text=this.adminTextarea.value; this.updateAnnouncementText(text); }
        };

        document.addEventListener("DOMContentLoaded",()=>AnnouncementManager.init());

        const pages=['loginPage','registerPage','welcomeMessage'];
        function showPage(pageId){ pages.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; }); const page=document.getElementById(pageId); if(page) page.style.display='block'; }
        window.onload=()=>{ showPage('welcomeMessage'); };
</script>
</body>
</html>
